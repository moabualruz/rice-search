# Rice Search Benchmark - Standalone Docker Compose
# This is a STANDALONE compose file - no base compose dependency
# Uses named volumes for data (cleaned on teardown)
# Uses bind mounts for model caches (persist across builds)
#
# Usage:
#   docker compose -f scripts/docker-compose.benchmark.yml --profile bge-m3 up -d
#   docker compose -f scripts/docker-compose.benchmark.yml down -v

volumes:
  bench-etcd:
  bench-redis:
  bench-minio:
  bench-milvus:
  bench-api-data:
  bench-tantivy:

services:
  # ============================================
  # Infrastructure: etcd (Milvus metadata store)
  # ============================================
  etcd:
    container_name: bench-etcd
    image: quay.io/coreos/etcd:v3.5.17
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - bench-etcd:/etcd
    command: >
      etcd
      --data-dir=/etcd
      --listen-client-urls=http://0.0.0.0:2379
      --advertise-client-urls=http://etcd:2379
      --listen-peer-urls=http://0.0.0.0:2380
      --initial-advertise-peer-urls=http://etcd:2380
      --initial-cluster=default=http://etcd:2380
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped
    networks:
      - bench-network

  # ============================================
  # Infrastructure: Redis (Job queue for BullMQ)
  # ============================================
  redis:
    container_name: bench-redis
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - bench-redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - bench-network

  # ============================================
  # Infrastructure: MinIO (Milvus object storage)
  # ============================================
  minio:
    container_name: bench-minio
    image: minio/minio:RELEASE.2024-12-18T13-15-00Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    volumes:
      - bench-minio:/minio_data
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped
    networks:
      - bench-network

  # ============================================
  # Milvus: Vector database (standalone mode)
  # ============================================
  milvus:
    container_name: bench-milvus
    image: milvusdb/milvus:v2.4.15
    command: ["milvus", "run", "standalone"]
    security_opt:
      - seccomp:unconfined
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: minioadmin
      MINIO_SECRET_ACCESS_KEY: minioadmin
      MINIO_USE_SSL: "false"
      MINIO_REGION: us-east-1
      QUERY_NODE_MAX_CONCURRENT: "256"
      PROXY_MAX_TASK_NUM: "1024"
      COMMON_GRACEFUL_TIME: "5000"
      COMMON_GRACEFUL_STOP_TIMEOUT: "30"
      QUERYCOORD_ENABLE_ACTIVE_STANDBY: "false"
      QUERYNODE_CACHE_ENABLED: "true"
      QUERYNODE_CACHE_SIZE: "1073741824"
      PROXY_MAX_CONNECTIONS: "65535"
    volumes:
      - bench-milvus:/var/lib/milvus
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      start_period: 90s
      timeout: 20s
      retries: 5
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - bench-network

  # ============================================
  # Infinity: Embedding + Reranking Server (CPU)
  # Model cache persists to ../data/ for faster rebuilds
  # ============================================
  infinity:
    container_name: bench-infinity
    image: michaelf34/infinity:latest-cpu
    command: >
      v2
      --model-id mixedbread-ai/mxbai-embed-large-v1
      --model-id mixedbread-ai/mxbai-rerank-xsmall-v1
      --port 80
      --batch-size 32
    volumes:
      - ../data/infinity-cache:/app/.cache
    environment:
      - HF_HOME=/app/.cache
      - HUGGING_FACE_HUB_TOKEN=${HF_TOKEN:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      start_period: 180s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - bench-network

  # ============================================
  # BGE-M3: Alternative embedding service
  # Uses image built by main docker-compose.yml
  # Model cache persists to ../data/ for faster rebuilds
  # ============================================
  bge-m3:
    container_name: bench-bge-m3
    image: rice-search-bge-m3:latest
    ports:
      - "8083:80"
    volumes:
      - ../data/bge-m3-cache:/app/.cache
    environment:
      - MODEL_NAME=BAAI/bge-m3
      - DEVICE=cpu
      - USE_FP16=true
      - BATCH_SIZE=32
      - MAX_LENGTH=8192
      - HF_HOME=/app/.cache
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      start_period: 180s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    profiles:
      - bge-m3
    networks:
      - bench-network

  # ============================================
  # API: Main integration point
  # Port configurable via API_PORT env var (default 8085)
  # Uses image built by main docker-compose.yml
  # ============================================
  api:
    container_name: bench-api
    image: rice-search-api:latest
    environment:
      MILVUS_HOST: milvus
      MILVUS_PORT: "19530"
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      INFINITY_URL: http://infinity:80
      INFINITY_EMBED_MODEL: mixedbread-ai/mxbai-embed-large-v1
      INFINITY_RERANK_MODEL: mixedbread-ai/mxbai-rerank-xsmall-v1
      BGE_M3_URL: http://bge-m3:80
      DATA_DIR: /data
      TANTIVY_INDEX_DIR: /tantivy
      EMBEDDING_DIM: "1024"
      SEARCH_MODE: mixedbread
      SPARSE_TOPK: "100"
      DENSE_TOPK: "100"
      FINAL_TOPK: "20"
      RRF_K: "60"
      RERANK_ENABLED: "true"
      RERANK_CANDIDATES: "30"
      RERANK_TIMEOUT_MS: "100"
      AUTH_MODE: none
      LOG_LEVEL: INFO
      CLUSTER_MODE: "false"
      NODE_ENV: production
      BUN_CONFIG_MAX_HTTP_CONNECTIONS: "1024"
    volumes:
      - bench-api-data:/data
      - bench-tantivy:/tantivy
    ports:
      - "${API_PORT:-8085}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 15s
      timeout: 10s
      retries: 3
    depends_on:
      milvus:
        condition: service_healthy
      infinity:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    networks:
      - bench-network

networks:
  bench-network:
    driver: bridge
    name: rice-benchmark
