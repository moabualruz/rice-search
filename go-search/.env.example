# Rice Search - Go Edition
# Environment Configuration
# Copy to .env and customize for your environment

# =============================================================================
# Server Configuration
# =============================================================================

# HTTP server host and port
RICE_HOST=0.0.0.0
RICE_PORT=8080

# Enable/disable services (monolith mode)
RICE_ENABLE_WEB=true
RICE_ENABLE_ML=true

# =============================================================================
# Qdrant Configuration
# =============================================================================

# Qdrant connection URL
QDRANT_URL=http://localhost:6333

# Qdrant API key (optional, for Qdrant Cloud)
# QDRANT_API_KEY=

# Collection prefix (useful for multi-tenant)
QDRANT_COLLECTION_PREFIX=rice_

# =============================================================================
# ML/ONNX Configuration
# =============================================================================

# Device for ML inference: cpu, cuda, tensorrt
# Default: cuda (GPU-first architecture)
# Set to "cpu" if no GPU available or for lower resource usage
RICE_ML_DEVICE=cuda

# CUDA device ID (if using GPU)
RICE_ML_CUDA_DEVICE=0

# Per-model GPU control (all default to true = GPU-first)
# These override RICE_ML_DEVICE on a per-model basis
RICE_EMBED_GPU=true
RICE_SPARSE_GPU=true
RICE_RERANK_GPU=true
RICE_QUERY_GPU=true

# Model paths (relative to models/ directory or absolute)
RICE_EMBED_MODEL=jina-embeddings-v3
RICE_SPARSE_MODEL=splade-v3
RICE_RERANK_MODEL=jina-reranker-v2

# Embedding dimensions (must match model)
RICE_EMBED_DIM=1536

# Batch sizes for inference
RICE_EMBED_BATCH_SIZE=32
RICE_SPARSE_BATCH_SIZE=32
RICE_RERANK_BATCH_SIZE=16

# Max sequence length
RICE_MAX_SEQ_LENGTH=8192

# =============================================================================
# Query Understanding
# =============================================================================

# Query understanding model (for intent detection and expansion)
RICE_QUERY_MODEL=microsoft/codebert-base

# Enable/disable query understanding
RICE_QUERY_MODEL_ENABLED=true

# =============================================================================
# Model Registry Configuration
# =============================================================================

# Directory where ONNX models are stored
RICE_MODELS_DIR=./models

# Model registry YAML file (tracks installed models)
RICE_MODELS_REGISTRY=./data/models/registry.yaml

# Model mappers directory (input/output transformations)
RICE_MODELS_MAPPERS=./data/models/mappers

# Auto-download missing models on startup
RICE_MODELS_AUTO_DOWNLOAD=false

# =============================================================================
# Cache Configuration
# =============================================================================

# Cache type: memory, redis
RICE_CACHE_TYPE=memory

# Memory cache size (number of entries)
RICE_CACHE_SIZE=10000

# Redis URL (if cache type is redis)
RICE_REDIS_URL=redis://localhost:6379

# Cache TTL in seconds (0 = never expire for embeddings)
RICE_CACHE_TTL=0

# =============================================================================
# Event Bus Configuration
# =============================================================================

# Bus type: memory, kafka, nats, redis
RICE_BUS_TYPE=memory

# Kafka brokers (comma-separated)
# RICE_KAFKA_BROKERS=localhost:9092

# NATS URL
# RICE_NATS_URL=nats://localhost:4222

# Redis Streams URL (for bus, can be same as cache)
# RICE_REDIS_STREAM_URL=redis://localhost:6379

# =============================================================================
# Indexing Configuration
# =============================================================================

# Maximum chunk size (tokens)
RICE_CHUNK_SIZE=512

# Chunk overlap (tokens)
RICE_CHUNK_OVERLAP=64

# Concurrent indexing workers
RICE_INDEX_WORKERS=4

# =============================================================================
# Search Configuration
# =============================================================================

# Default top_k results
RICE_DEFAULT_TOP_K=20

# Default sparse weight (0.0-1.0)
RICE_DEFAULT_SPARSE_WEIGHT=0.5

# Default dense weight (0.0-1.0)
RICE_DEFAULT_DENSE_WEIGHT=0.5

# Enable reranking by default
RICE_ENABLE_RERANKING=true

# Rerank candidates multiplier
RICE_RERANK_CANDIDATES=30

# Search Post-Processing
# Enable semantic deduplication (removes near-duplicate chunks based on embedding similarity)
RICE_ENABLE_DEDUP=true

# Deduplication similarity threshold (0.0-1.0, higher = more strict, 0.85 means 85% similar chunks removed)
RICE_DEDUP_THRESHOLD=0.85

# Enable MMR diversity (Maximal Marginal Relevance - balances relevance with result diversity)
RICE_ENABLE_DIVERSITY=true

# Diversity vs relevance trade-off (0.0-1.0, 0=max diversity, 1=max relevance)
RICE_DIVERSITY_LAMBDA=0.7

# Group results by file (shows representative chunks from each file)
RICE_GROUP_BY_FILE=false

# Maximum chunks per file when grouping is enabled
RICE_MAX_CHUNKS_PER_FILE=3

# =============================================================================
# Logging Configuration
# =============================================================================

# Log level: debug, info, warn, error
RICE_LOG_LEVEL=info

# Log format: text, json
RICE_LOG_FORMAT=text

# Log file (empty = stdout)
# RICE_LOG_FILE=

# =============================================================================
# Security Configuration
# =============================================================================

# API key for authentication (empty = no auth)
# RICE_API_KEY=

# Rate limit (requests per second, 0 = disabled)
RICE_RATE_LIMIT=0

# CORS allowed origins (comma-separated, * = all)
RICE_CORS_ORIGINS=*

# =============================================================================
# Observability Configuration
# =============================================================================

# Enable Prometheus metrics endpoint
RICE_METRICS_ENABLED=true

# Metrics endpoint path
RICE_METRICS_PATH=/metrics

# Enable request tracing
RICE_TRACING_ENABLED=false

# Jaeger/OTLP endpoint
# RICE_TRACING_ENDPOINT=http://localhost:4318

# =============================================================================
# Connection Tracking (unique go-search feature)
# =============================================================================

# Enable connection/PC tracking for client identification and access control
# Tracks unique client machines (ricegrep CLI instances) by MAC address,
# hostname, and username. Enables per-connection usage statistics and 
# default search scoping (clients see only their indexed files by default).
RICE_CONNECTIONS_ENABLED=true

# Storage path for connection data (persisted as JSON files)
# Each connection stored as: {path}/{connectionID}.json
RICE_CONNECTIONS_PATH=./data/connections

# Days of inactivity before marking a connection as inactive
# Inactive connections are hidden from active lists but preserved for auditing
RICE_CONNECTIONS_MAX_INACTIVE=30

# =============================================================================
# Microservices Mode (optional - for distributed deployment)
# =============================================================================

# External ML service URL (skip embedded ML)
# RICE_ML_URL=http://ml-service:8081

# External Search service URL (skip embedded search)
# RICE_SEARCH_URL=http://search-service:8082

# =============================================================================
# Advanced Configuration (optional)
# =============================================================================

# Qdrant timeout for requests (default: 30s)
QDRANT_TIMEOUT=30s

# Event Bus Logging (optional - for debugging event flow)
# Logs all events to file when enabled
# RICE_EVENT_LOG_ENABLED=false
# RICE_EVENT_LOG_PATH=./data/events/events.log

# Metrics Persistence (optional - for metrics across restarts)
# Options: "memory" (default) or "redis"
# If "redis", metrics survive server restarts
# RICE_METRICS_PERSISTENCE=memory
# RICE_METRICS_REDIS_URL=redis://localhost:6379/0

# Settings Audit Trail (enabled by default)
# Logs all setting changes with timestamp and source
RICE_SETTINGS_AUDIT_ENABLED=true
RICE_SETTINGS_AUDIT_PATH=./data/audit/settings.log
