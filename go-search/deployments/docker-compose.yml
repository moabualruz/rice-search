# Rice Search - Go Edition
# Docker Compose for local development and deployment

services:
  # ===========================================================================
  # Rice Search Application
  # ===========================================================================
  rice-search:
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile
    container_name: rice-search
    ports:
      - "8080:8080"
    environment:
      - RICE_HOST=0.0.0.0
      - RICE_PORT=8080
      - RICE_LOG_LEVEL=info
      - RICE_LOG_FORMAT=json
      - QDRANT_URL=http://qdrant:6333
      - RICE_ML_DEVICE=cpu
      - RICE_CACHE_TYPE=memory
      - RICE_BUS_TYPE=memory
    volumes:
      - rice-models:/app/models
      - rice-data:/app/data
    depends_on:
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    profiles:
      - full

  # ===========================================================================
  # Qdrant Vector Database
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:v1.12.4
    container_name: rice-qdrant
    ports:
      - "6333:6333"   # HTTP API
      - "6334:6334"   # gRPC API
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ===========================================================================
  # Qdrant Web UI (optional, for debugging)
  # ===========================================================================
  qdrant-ui:
    image: qdrant/qdrant-web-ui:latest
    container_name: rice-qdrant-ui
    ports:
      - "8001:80"
    environment:
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      - qdrant
    profiles:
      - dev

  # ===========================================================================
  # Redis (optional, for distributed cache/bus)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: rice-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    profiles:
      - distributed

volumes:
  qdrant-data:
    name: rice-qdrant-data
  rice-models:
    name: rice-models
  rice-data:
    name: rice-data
  redis-data:
    name: rice-redis-data

networks:
  default:
    name: rice-network
