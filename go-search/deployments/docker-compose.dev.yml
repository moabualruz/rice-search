# Rice Search - Go Edition
# Development Docker Compose - Only Qdrant (run server from code locally)

services:
  # ===========================================================================
  # Qdrant Vector Database
  # Dashboard: http://localhost:6333/dashboard
  # GPU support requires v1.13.0+. Switch images by commenting/uncommenting:
  # ===========================================================================
  qdrant:
    # GPU NVIDIA (requires nvidia-container-toolkit on host)
    image: qdrant/qdrant:v1.13.0-gpu-nvidia
    # GPU AMD (requires ROCm on host) - uncomment and comment above:
    # image: qdrant/qdrant:v1.13.0-gpu-amd
    # CPU only - uncomment and comment above:
    # image: qdrant/qdrant:v1.13.0
    container_name: rice-qdrant-dev
    ports:
      - "6333:6333"   # HTTP API + Dashboard
      - "6334:6334"   # gRPC API
    volumes:
      - ../data/qdrant-dev:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=DEBUG
      # GPU indexing - set to 0 or remove if using CPU image
      - QDRANT__GPU__INDEXING=1
    # NVIDIA GPU support - remove/comment this block if using CPU or AMD image
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # AMD GPU support - uncomment this block if using AMD image (and remove NVIDIA block above):
    # devices:
    #   - /dev/kfd
    #   - /dev/dri
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:6333/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # ===========================================================================
  # Redis (for distributed cache/bus)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: rice-redis-dev
    ports:
      - "6379:6379"
    volumes:
      - ../data/redis-dev:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

networks:
  default:
    name: rice-dev-network
