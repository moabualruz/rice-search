// Rice Search gRPC Service Definition
// Protocol buffer definitions for the Rice Search platform.

syntax = "proto3";

package ricesearch.v1;

option go_package = "github.com/ricesearch/rice-search/api/proto/ricesearchpb";

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";

// =============================================================================
// Rice Search Service - Main gRPC service
// =============================================================================

service RiceSearch {
  // Search performs hybrid search with optional reranking.
  // Returns a stream of results for large result sets.
  rpc Search(SearchRequest) returns (SearchResponse);
  
  // SearchStream performs search and streams results as they're found.
  // Use this for progressive result display in UIs.
  rpc SearchStream(SearchRequest) returns (stream SearchResult);

  // Index indexes documents into a store.
  // Supports streaming for large batches.
  rpc Index(stream IndexRequest) returns (IndexResponse);
  
  // IndexBatch indexes a batch of documents (non-streaming alternative).
  rpc IndexBatch(IndexBatchRequest) returns (IndexResponse);
  
  // Delete removes documents from the index.
  rpc Delete(DeleteRequest) returns (DeleteResponse);
  
  // Sync removes documents that no longer exist.
  rpc Sync(SyncRequest) returns (SyncResponse);
  
  // Reindex clears and rebuilds the entire index.
  rpc Reindex(ReindexRequest) returns (IndexResponse);
  
  // GetIndexStats returns indexing statistics.
  rpc GetIndexStats(GetIndexStatsRequest) returns (IndexStats);

  // ListStores returns all stores.
  rpc ListStores(ListStoresRequest) returns (ListStoresResponse);
  
  // CreateStore creates a new store.
  rpc CreateStore(CreateStoreRequest) returns (Store);
  
  // GetStore retrieves a store by name.
  rpc GetStore(GetStoreRequest) returns (Store);
  
  // DeleteStore deletes a store.
  rpc DeleteStore(DeleteStoreRequest) returns (DeleteStoreResponse);
  
  // GetStoreStats returns statistics for a store.
  rpc GetStoreStats(GetStoreStatsRequest) returns (StoreStats);

  // Health returns service health status.
  rpc Health(HealthRequest) returns (HealthResponse);
  
  // Version returns version information.
  rpc Version(VersionRequest) returns (VersionResponse);
  
  // Connection Management
  rpc RegisterConnection(RegisterConnectionRequest) returns (Connection);
  rpc ListConnections(ListConnectionsRequest) returns (ListConnectionsResponse);
  rpc GetConnection(GetConnectionRequest) returns (Connection);
  rpc DeleteConnection(DeleteConnectionRequest) returns (DeleteConnectionResponse);
  
  // Model Management
  rpc ListModels(ListModelsRequest) returns (ListModelsResponse);
  rpc DownloadModel(DownloadModelRequest) returns (DownloadModelResponse);
  rpc SetDefaultModel(SetDefaultModelRequest) returns (ModelInfo);
  rpc ToggleGPU(ToggleGPURequest) returns (ModelInfo);
  
  // Model Mapper Management
  rpc ListMappers(ListMappersRequest) returns (ListMappersResponse);
  rpc CreateMapper(CreateMapperRequest) returns (ModelMapper);
  rpc UpdateMapper(UpdateMapperRequest) returns (ModelMapper);
  rpc DeleteMapper(DeleteMapperRequest) returns (DeleteMapperResponse);
  rpc GenerateMapper(GenerateMapperRequest) returns (ModelMapper);
  
  // File Browser
  rpc ListFiles(ListFilesRequest) returns (ListFilesResponse);
  
  // GetChunks retrieves all chunks for a specific file.
  rpc GetChunks(GetChunksRequest) returns (GetChunksResponse);
}

// =============================================================================
// Search Messages
// =============================================================================

message SearchRequest {
  // Query is the search query text (required).
  string query = 1;
  
  // Store is the store to search in (required).
  string store = 2;
  
  // TopK is the number of results to return (default: 20).
  int32 top_k = 3;
  
  // Filter constrains the search.
  SearchFilter filter = 4;
  
  // EnableReranking enables neural reranking.
  optional bool enable_reranking = 5;
  
  // RerankTopK is the number of candidates to rerank.
  int32 rerank_top_k = 6;
  
  // IncludeContent includes full content in results.
  bool include_content = 7;
  
  // SparseWeight overrides the sparse weight (0-1).
  optional float sparse_weight = 8;
  
  // DenseWeight overrides the dense weight (0-1).
  optional float dense_weight = 9;
  
  // ConnectionID filters results by connection.
  string connection_id = 10;
}

message SearchFilter {
  // PathPrefix filters by path prefix.
  string path_prefix = 1;
  
  // Languages filters by programming language.
  repeated string languages = 2;
}

message SearchResult {
  // ID is the chunk identifier.
  string id = 1;
  
  // Path is the file path.
  string path = 2;
  
  // Language is the programming language.
  string language = 3;
  
  // StartLine is the starting line number.
  int32 start_line = 4;
  
  // EndLine is the ending line number.
  int32 end_line = 5;
  
  // Content is the chunk content (if requested).
  string content = 6;
  
  // Symbols are the extracted symbols.
  repeated string symbols = 7;
  
  // Score is the relevance score.
  float score = 8;
  
  // RerankScore is the reranker score (if reranking was applied).
  optional float rerank_score = 9;
}

message SearchResponse {
  // Query is the original query.
  string query = 1;
  
  // Store is the store that was searched.
  string store = 2;
  
  // Results are the search results.
  repeated SearchResult results = 3;
  
  // Total is the total number of matches (before limit).
  int32 total = 4;
  
  // Metadata contains search metadata.
  SearchMetadata metadata = 5;
  
  // ParsedQuery contains query understanding results (if available).
  optional ParsedQuery parsed_query = 6;
}

// NOTE: ParsedQuery is defined below in the Query Understanding section (line 843+)

message SearchMetadata {
  // SearchTimeMs is the total search time in milliseconds.
  int64 search_time_ms = 1;
  
  // EmbedTimeMs is the embedding generation time.
  int64 embed_time_ms = 2;
  
  // RetrievalTimeMs is the vector search time.
  int64 retrieval_time_ms = 3;
  
  // RerankTimeMs is the reranking time (if applied).
  int64 rerank_time_ms = 4;
  
  // CandidatesReranked is the number of candidates that were reranked.
  int32 candidates_reranked = 5;
  
  // RerankingApplied indicates if reranking was applied.
  bool reranking_applied = 6;
}

// =============================================================================
// Index Messages
// =============================================================================

message IndexRequest {
  // Store is the target store (required on first message).
  string store = 1;
  
  // Document is the document to index.
  Document document = 2;
  
  // Force re-indexes even if unchanged.
  bool force = 3;
  
  // ConnectionID tracks the source connection.
  string connection_id = 4;
}

message IndexBatchRequest {
  // Store is the target store.
  string store = 1;
  
  // Documents are the documents to index.
  repeated Document documents = 2;
  
  // Force re-indexes even if unchanged.
  bool force = 3;
}

message Document {
  // Path is the file path (required).
  string path = 1;
  
  // Content is the file content (required).
  string content = 2;
  
  // Language is the programming language (optional, auto-detected if empty).
  string language = 3;
}

message IndexResponse {
  // Store is the target store.
  string store = 1;
  
  // Indexed is the number of documents indexed.
  int32 indexed = 2;
  
  // Skipped is the number of documents skipped (unchanged).
  int32 skipped = 3;
  
  // Failed is the number of documents that failed.
  int32 failed = 4;
  
  // ChunksTotal is the total number of chunks created.
  int32 chunks_total = 5;
  
  // Duration is the indexing duration.
  google.protobuf.Duration duration = 6;
  
  // Errors are indexing errors.
  repeated IndexError errors = 7;
  
  // DocumentInfo contains info about each document.
  repeated DocumentInfo document_info = 8;
}

message IndexError {
  // Path is the file path.
  string path = 1;
  
  // Message is the error message.
  string message = 2;
}

message DocumentInfo {
  // Path is the file path.
  string path = 1;
  
  // Hash is the content hash.
  string hash = 2;
  
  // ChunkCount is the number of chunks created.
  int32 chunk_count = 3;
  
  // Status is the indexing status (indexed, skipped, failed).
  string status = 4;
}

message DeleteRequest {
  // Store is the target store.
  string store = 1;
  
  // Paths are specific file paths to delete.
  repeated string paths = 2;
  
  // PathPrefix deletes all files with this prefix.
  string path_prefix = 3;
}

message DeleteResponse {
  // Deleted is the number of documents deleted.
  int32 deleted = 1;
}

message SyncRequest {
  // Store is the target store.
  string store = 1;
  
  // CurrentPaths are paths that currently exist.
  repeated string current_paths = 2;
}

message SyncResponse {
  // Removed is the number of documents removed.
  int32 removed = 1;
}

message ReindexRequest {
  // Store is the target store.
  string store = 1;
  
  // Documents are the documents to reindex.
  repeated Document documents = 2;
}

message GetIndexStatsRequest {
  // Store is the target store.
  string store = 1;
}

message IndexStats {
  // Store is the store name.
  string store = 1;
  
  // TotalChunks is the total number of indexed chunks.
  int32 total_chunks = 2;
  
  // TotalFiles is the total number of indexed files.
  int32 total_files = 3;
}

// =============================================================================
// Store Messages
// =============================================================================

message Store {
  // Name is the store identifier (required).
  string name = 1;
  
  // DisplayName is a human-friendly name.
  string display_name = 2;
  
  // Description is an optional description.
  string description = 3;
  
  // Config is the store configuration.
  StoreConfig config = 4;
  
  // Stats are the store statistics.
  StoreStats stats = 5;
  
  // CreatedAt is when the store was created.
  google.protobuf.Timestamp created_at = 6;
  
  // UpdatedAt is when the store was last updated.
  google.protobuf.Timestamp updated_at = 7;
}

message StoreConfig {
  // EmbedModel is the dense embedding model name.
  string embed_model = 1;
  
  // SparseModel is the sparse encoding model name.
  string sparse_model = 2;
  
  // ChunkSize is the target chunk size in tokens.
  int32 chunk_size = 3;
  
  // ChunkOverlap is the overlap between chunks in tokens.
  int32 chunk_overlap = 4;
}

message StoreStats {
  // DocumentCount is the number of source files.
  int64 document_count = 1;
  
  // ChunkCount is the number of indexed chunks.
  int64 chunk_count = 2;
  
  // TotalSize is the total content size in bytes.
  int64 total_size = 3;
  
  // LastIndexed is when the store was last indexed.
  google.protobuf.Timestamp last_indexed = 4;
}

message ListStoresRequest {}

message ListStoresResponse {
  // Stores are all stores.
  repeated Store stores = 1;
}

message CreateStoreRequest {
  // Name is the store identifier (required).
  string name = 1;
  
  // DisplayName is a human-friendly name.
  string display_name = 2;
  
  // Description is an optional description.
  string description = 3;
  
  // Config is the store configuration.
  StoreConfig config = 4;
}

message GetStoreRequest {
  // Name is the store identifier.
  string name = 1;
}

message DeleteStoreRequest {
  // Name is the store identifier.
  string name = 1;
}

message DeleteStoreResponse {
  // Success indicates if deletion was successful.
  bool success = 1;
}

message GetStoreStatsRequest {
  // Name is the store identifier.
  string name = 1;
}

// =============================================================================
// Health & Version Messages
// =============================================================================

message HealthRequest {}

message HealthResponse {
  // Status is the overall health status.
  HealthStatus status = 1;
  
  // Components are individual component health.
  map<string, ComponentHealth> components = 2;
  
  // Version is the server version.
  string version = 3;
}

enum HealthStatus {
  HEALTH_STATUS_UNSPECIFIED = 0;
  HEALTH_STATUS_HEALTHY = 1;
  HEALTH_STATUS_DEGRADED = 2;
  HEALTH_STATUS_UNHEALTHY = 3;
}

message ComponentHealth {
  // Status is the component health status.
  HealthStatus status = 1;
  
  // Message is an optional status message.
  string message = 2;
  
  // Latency is the component check latency.
  google.protobuf.Duration latency = 3;
  
  // DeviceInfo contains ML device information (only for ML component)
  DeviceInfo device_info = 4;
}

message DeviceInfo {
  // Device is the requested device (cpu, cuda, tensorrt)
  string device = 1;
  
  // ActualDevice is the device actually being used
  string actual_device = 2;
  
  // DeviceFallback is true if actual differs from requested
  bool device_fallback = 3;
  
  // RuntimeAvailable is true if ONNX Runtime is available
  bool runtime_available = 4;
}

message VersionRequest {}

message VersionResponse {
  // Version is the semantic version.
  string version = 1;
  
  // Commit is the git commit hash.
  string commit = 2;
  
  // BuildDate is when the binary was built.
  string build_date = 3;
  
  // GoVersion is the Go version used.
  string go_version = 4;
}

// =============================================================================
// Connection Management Messages
// =============================================================================

message Connection {
  // ID is the unique connection identifier.
  string id = 1;
  
  // Name is a user-friendly connection name.
  string name = 2;
  
  // PCInfo contains PC information.
  PCInfo pc_info = 3;
  
  // StoreAccess lists stores this connection can access.
  repeated string store_access = 4;
  
  // CreatedAt is when the connection was created.
  google.protobuf.Timestamp created_at = 5;
  
  // LastSeenAt is when the connection was last active.
  google.protobuf.Timestamp last_seen_at = 6;
  
  // LastIP is the last IP address used.
  string last_ip = 7;
  
  // IndexedFiles is the number of files indexed by this connection.
  int64 indexed_files = 8;
  
  // SearchCount is the number of searches performed.
  int64 search_count = 9;
  
  // IsActive indicates if the connection is currently active.
  bool is_active = 10;
}

message PCInfo {
  // Hostname is the computer name.
  string hostname = 1;
  
  // OS is the operating system.
  string os = 2;
  
  // Arch is the CPU architecture.
  string arch = 3;
  
  // MACAddress is the MAC address (optional).
  string mac_address = 4;
  
  // Username is the OS username (optional).
  string username = 5;
}

message RegisterConnectionRequest {
  // Name is a user-friendly connection name.
  string name = 1;
  
  // PCInfo contains PC information.
  PCInfo pc_info = 2;
}

message ListConnectionsRequest {
  // StoreFilter filters by store access (optional).
  string store_filter = 1;
  
  // ActiveOnly filters to only active connections.
  bool active_only = 2;
}

message ListConnectionsResponse {
  // Connections is the list of connections.
  repeated Connection connections = 1;
}

message GetConnectionRequest {
  // ID is the connection identifier.
  string id = 1;
}

message DeleteConnectionRequest {
  // ID is the connection identifier.
  string id = 1;
}

message DeleteConnectionResponse {
  // Success indicates if deletion was successful.
  bool success = 1;
}

// =============================================================================
// Model Management Messages
// =============================================================================

message ModelInfo {
  // ID is the model identifier.
  string id = 1;
  
  // Type is the model type (embed, rerank, query_understand).
  string type = 2;
  
  // DisplayName is a human-friendly name.
  string display_name = 3;
  
  // Description describes the model.
  string description = 4;
  
  // OutputDim is the output dimension (for embeddings).
  int32 output_dim = 5;
  
  // MaxTokens is the maximum token count.
  int32 max_tokens = 6;
  
  // Downloaded indicates if the model is downloaded.
  bool downloaded = 7;
  
  // IsDefault indicates if this is the default model for its type.
  bool is_default = 8;
  
  // GPUEnabled indicates if GPU acceleration is enabled.
  bool gpu_enabled = 9;
  
  // Size is the model size in bytes.
  int64 size = 10;
}

message ListModelsRequest {
  // TypeFilter filters by model type (optional).
  string type_filter = 1;
}

message ListModelsResponse {
  // Models is the list of available models.
  repeated ModelInfo models = 1;
}

message DownloadModelRequest {
  // ModelID is the model to download.
  string model_id = 1;
}

message DownloadModelResponse {
  // Success indicates if download was successful.
  bool success = 1;
  
  // Message contains status or error message.
  string message = 2;
  
  // Progress is the download progress (0-100).
  int32 progress = 3;
}

message SetDefaultModelRequest {
  // ModelType is the model type (embed, rerank, query_understand).
  string model_type = 1;
  
  // ModelID is the model to set as default.
  string model_id = 2;
}

message ToggleGPURequest {
  // ModelID is the model to toggle GPU for.
  string model_id = 1;
  
  // Enabled indicates if GPU should be enabled.
  bool enabled = 2;
}

// =============================================================================
// Model Mapper Messages
// =============================================================================

message ModelMapper {
  // ID is the mapper identifier.
  string id = 1;
  
  // Name is a human-friendly mapper name.
  string name = 2;
  
  // ModelID is the target model.
  string model_id = 3;
  
  // Type is the mapper type.
  string type = 4;
  
  // PromptTemplate is the prompt template (optional).
  string prompt_template = 5;
  
  // InputMapping maps input fields.
  map<string, string> input_mapping = 6;
  
  // OutputMapping maps output fields.
  map<string, string> output_mapping = 7;
  
  // CreatedAt is when the mapper was created.
  google.protobuf.Timestamp created_at = 8;
  
  // UpdatedAt is when the mapper was last updated.
  google.protobuf.Timestamp updated_at = 9;
}

message ListMappersRequest {}

message ListMappersResponse {
  // Mappers is the list of model mappers.
  repeated ModelMapper mappers = 1;
}

message CreateMapperRequest {
  // Mapper is the mapper to create.
  ModelMapper mapper = 1;
}

message UpdateMapperRequest {
  // Mapper is the mapper to update.
  ModelMapper mapper = 1;
}

message DeleteMapperRequest {
  // ID is the mapper identifier.
  string id = 1;
}

message DeleteMapperResponse {
  // Success indicates if deletion was successful.
  bool success = 1;
}

message GenerateMapperRequest {
  // ModelID is the model to generate mapper for.
  string model_id = 1;
  
  // Type is the mapper type to generate.
  string type = 2;
}

// =============================================================================
// File Browser Messages
// =============================================================================

message IndexedFile {
  // Path is the file path.
  string path = 1;
  
  // Language is the programming language.
  string language = 2;
  
  // Size is the file size in bytes.
  int64 size = 3;
  
  // Hash is the content hash.
  string hash = 4;
  
  // ChunkCount is the number of chunks.
  int32 chunk_count = 5;
  
  // ConnectionID is the source connection.
  string connection_id = 6;
  
  // IndexedAt is when the file was indexed.
  google.protobuf.Timestamp indexed_at = 7;
  
  // Status is the indexing status (indexed, pending, error).
  string status = 8;
}

message ListFilesRequest {
  // Store is the target store.
  string store = 1;
  
  // PathPrefix filters by path prefix (optional).
  string path_prefix = 2;
  
  // Language filters by language (optional).
  string language = 3;
  
  // ConnectionID filters by connection (optional).
  string connection_id = 4;
  
  // Status filters by status (optional).
  string status = 5;
  
  // Page is the page number (1-indexed).
  int32 page = 6;
  
  // PageSize is the number of results per page.
  int32 page_size = 7;
  
  // SortBy is the field to sort by (path, size, indexed_at).
  string sort_by = 8;
  
  // SortOrder is the sort order (asc, desc).
  string sort_order = 9;
}

message ListFilesResponse {
  // Files is the list of indexed files.
  repeated IndexedFile files = 1;
  
  // Total is the total number of files.
  int32 total = 2;
  
  // Page is the current page number.
  int32 page = 3;
  
  // PageSize is the page size.
  int32 page_size = 4;
  
  // TotalPages is the total number of pages.
  int32 total_pages = 5;
}

// =============================================================================
// Chunk Messages
// =============================================================================

message GetChunksRequest {
  // Store is the target store.
  string store = 1;
  
  // Path is the file path to get chunks for.
  string path = 2;
}

message Chunk {
  // ID is the chunk identifier.
  string id = 1;
  
  // StartLine is the starting line number.
  int32 start_line = 2;
  
  // EndLine is the ending line number.
  int32 end_line = 3;
  
  // Content is the chunk content.
  string content = 4;
  
  // Symbols are extracted symbols.
  repeated string symbols = 5;
  
  // Hash is the chunk hash.
  string hash = 6;
}

message GetChunksResponse {
  // Path is the file path.
  string path = 1;
  
  // Chunks are the file chunks.
  repeated Chunk chunks = 2;
  
  // Total is the total number of chunks.
  int32 total = 3;
}

// =============================================================================
// Query Understanding Messages
// =============================================================================

message ParsedQuery {
  // Original is the original query text.
  string original = 1;
  
  // Normalized is the normalized query.
  string normalized = 2;
  
  // Keywords are extracted keywords.
  repeated string keywords = 3;
  
  // CodeTerms are code-specific terms.
  repeated string code_terms = 4;
  
  // ActionIntent is the detected action intent.
  string action_intent = 5;
  
  // TargetType is the target code element type.
  string target_type = 6;
  
  // Expanded contains query expansions.
  repeated string expanded = 7;
  
  // SearchQuery is the final search query.
  string search_query = 8;
  
  // Confidence is the parsing confidence (0-1).
  float confidence = 9;
  
  // UsedModel indicates if a model was used.
  bool used_model = 10;
}
