# Rice Search Platform - Docker Compose
# Cross-platform: Windows+WSL2, Linux, macOS (CPU)
# All data persisted to ./data via bind mounts

services:
  # ============================================
  # Infrastructure: etcd (Milvus metadata store)
  # ============================================
  etcd:
    container_name: rice-etcd
    image: quay.io/coreos/etcd:v3.5.17
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - ./data/etcd:/etcd
    command: >
      etcd
      --data-dir=/etcd
      --listen-client-urls=http://0.0.0.0:2379
      --advertise-client-urls=http://etcd:2379
      --listen-peer-urls=http://0.0.0.0:2380
      --initial-advertise-peer-urls=http://etcd:2380
      --initial-cluster=default=http://etcd:2380
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped
    networks:
      - rice-network

  # ============================================
  # Infrastructure: Redis (Job queue for BullMQ)
  # ============================================
  redis:
    container_name: rice-redis
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - ./data/redis:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - rice-network

  # ============================================
  # Infrastructure: MinIO (Milvus object storage)
  # ============================================
  minio:
    container_name: rice-minio
    image: minio/minio:RELEASE.2024-12-18T13-15-44Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    volumes:
      - ./data/minio:/minio_data
    command: minio server /minio_data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped
    networks:
      - rice-network

  # ============================================
  # Milvus: Vector database (standalone mode)
  # ============================================
  milvus:
    container_name: rice-milvus
    image: milvusdb/milvus:v2.4.15
    command: ["milvus", "run", "standalone"]
    security_opt:
      - seccomp:unconfined
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: minioadmin
      MINIO_SECRET_ACCESS_KEY: minioadmin
      MINIO_USE_SSL: "false"
      MINIO_REGION: us-east-1
      # Performance tuning
      QUERY_NODE_MAX_CONCURRENT: "256"         # Max concurrent queries
      PROXY_MAX_TASK_NUM: "1024"               # Max queued tasks
      COMMON_GRACEFUL_TIME: "5000"             # Faster shutdown
      COMMON_GRACEFUL_STOP_TIMEOUT: "30"
      # Query cache - cache search results
      QUERYCOORD_ENABLE_ACTIVE_STANDBY: "false"
      # Memory management
      QUERYNODE_CACHE_ENABLED: "true"
      QUERYNODE_CACHE_SIZE: "2147483648"       # 2GB query cache
      # Connection handling
      PROXY_MAX_CONNECTIONS: "65535"           # Max client connections
      # gRPC message size limits (fixes RESOURCE_EXHAUSTED on large batches)
      GRPC_SERVERMAXTOKENPERSET: "1073741824"  # 1GB max tokens
      PROXY_MAXMSGSIZE: "268435456"            # 256MB max message size
      COMMON_MAXMSGSIZE: "268435456"           # 256MB max message size
      # Insert buffer tuning
      DATANODE_FLUSH_INSERT_BUFFER_SIZE: "268435456"  # 256MB insert buffer
    volumes:
      - ./data/milvus:/var/lib/milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      start_period: 90s
      timeout: 20s
      retries: 5
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
    networks:
      - rice-network

  # ============================================
  # Attu: Milvus admin UI
  # ============================================
  attu:
    container_name: rice-attu
    image: zilliz/attu:v2.4
    environment:
      MILVUS_URL: milvus:19530
    ports:
      - "8000:3000"
    depends_on:
      milvus:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - rice-network

  # ============================================
  # Infinity: Embedding + Reranking Server (CPU)
  # 
  # Models (Dec 2025):
  # - mixedbread-ai/mxbai-embed-large-v1 (1024d embeddings, SOTA quality)
  # - mixedbread-ai/mxbai-rerank-xsmall-v1 (officially supported reranker)
  #
  # For GPU, use docker-compose.gpu.yml override
  # ============================================
  infinity:
    container_name: rice-infinity
    image: michaelf34/infinity:latest-cpu
    command: >
      v2
      --model-id mixedbread-ai/mxbai-embed-large-v1
      --model-id mixedbread-ai/mxbai-rerank-xsmall-v1
      --engine torch
      --port 80
      --batch-size 32
    volumes:
      - ./data/infinity-cache:/app/.cache
    ports:
      - "8081:80"
    environment:
      - HF_HOME=/app/.cache
      - HUGGING_FACE_HUB_TOKEN=${HF_TOKEN:-}
      - INFINITY_ENGINE=torch
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      start_period: 180s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - rice-network

  # ============================================
  # API: Main integration point
  # All clients connect here (8080)
  # ============================================
  api:
    container_name: rice-api
    build:
      context: ./api
      dockerfile: Dockerfile
    environment:
      # Service connections
      MILVUS_HOST: milvus
      MILVUS_PORT: "19530"
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      
      # Infinity (embedding + reranking)
      INFINITY_URL: http://infinity:80
      INFINITY_EMBED_MODEL: mixedbread-ai/mxbai-embed-large-v1
      INFINITY_RERANK_MODEL: mixedbread-ai/mxbai-rerank-xsmall-v1
      
      # Data directories
      DATA_DIR: /data
      TANTIVY_INDEX_DIR: /tantivy
      
      # Model configuration
      EMBEDDING_DIM: "1024"
      
      # Search configuration
      SPARSE_TOPK: "100"
      DENSE_TOPK: "100"
      FINAL_TOPK: "20"
      RRF_K: "60"
      
      # Reranking configuration
      # Neural reranking improves NL query results by 20-35%
      # Uses mixedbread-ai/mxbai-rerank-xsmall-v1 (Mixedbread mode) or ColBERT (BGE-M3 mode)
      RERANK_ENABLED: "true"
      RERANK_CANDIDATES: "30"
      RERANK_TIMEOUT_MS: "100"
      
      # Auth (disabled by default)
      AUTH_MODE: none
      
      # Logging
      LOG_LEVEL: INFO
      
      # Single process mode - Bun async I/O handles concurrency well
      # Clustering disabled to simplify Tantivy queue serialization
      CLUSTER_MODE: "false"
      NODE_ENV: production
      
      # Bun runtime tuning
      BUN_CONFIG_MAX_HTTP_CONNECTIONS: "1024"
    volumes:
      - ./data/api:/data
      - ./data/tantivy:/tantivy
      # Mount repos for server-side indexing (optional)
      - ${REPOS_PATH:-./repos}:/repos:ro
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 15s
      timeout: 10s
      retries: 3
    depends_on:
      milvus:
        condition: service_healthy
      infinity:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    networks:
      - rice-network

  # ============================================
  # Web UI: Simple search interface
  # Commented out for initial testing - can access API directly
  # ============================================
  web-ui:
    container_name: rice-web-ui
    build:
      context: ./web-ui
      dockerfile: Dockerfile
    environment:
      # For server-side proxying within Docker network
      API_URL: http://api:8080
    ports:
      - "3000:3000"
    depends_on:
      api:
          condition: service_healthy
    restart: unless-stopped
    networks:
      - rice-network

networks:
  rice-network:
    driver: bridge
    name: rice-search
